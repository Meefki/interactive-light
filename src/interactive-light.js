var L=Object.defineProperty;var B=i=>{throw TypeError(i)};var _=(i,e,t)=>e in i?L(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var l=(i,e,t)=>_(i,typeof e!="symbol"?e+"":e,t),ee=(i,e,t)=>e.has(i)||B("Cannot "+t);var f=(i,e,t)=>(ee(i,e,"read from private field"),t?t.call(i):e.get(i)),x=(i,e,t)=>e.has(i)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t);const J="flags",d="interactive-light",z="interactive",F="path",H="token-id",y=`${J}.${d}.${z}`,E=`${J}.${d}.${F}`,N="light-id",M="INTERACTIVE_LIGHT",te=`${M}.Enabled`,ce=`${M}.EnabledHint`,ae=`${M}.Path`,ne=CONST.DEFAULT_TOKEN;var Y,C;const oe=((C=(Y=game.canvas)==null?void 0:Y.grid)==null?void 0:C.size)??100;var W,V;const se=((V=(W=game.canvas)==null?void 0:W.grid)==null?void 0:V.size)??100,X="InteractiveLight",O=class O{};l(O,"getFolder",async()=>{var t;let e=(t=game.folders)==null?void 0:t.getName(X);return e||(e=await O.createFolder()),e}),l(O,"createFolder",async()=>await Folder.create({name:X,type:"Actor"}));let A=O;const G="color: #7bf542",b="color: #d8eb34",R="color: #ffffff";var Q=(i=>(i[i.debug=0]="debug",i[i.info=1]="info",i[i.warn=2]="warn",i[i.error=3]="error",i))(Q||{});class s{static log(...e){this.minLogLevel>0||console.log("%c Interactive%cLight %c",G,b,R,...e)}static info(...e){this.minLogLevel>1||console.info("%c Interactive%cLight %c",G,b,R,...e)}static warn(...e){this.minLogLevel>2||console.warn("%c Interactive%cLight %c",G,b,R,...e)}static error(...e){this.minLogLevel>3||console.error("%c Interactive%cLight %c",G,b,R,...e)}}l(s,"minLogLevel",2);const v=class v{};l(v,"init",()=>{socketlib.registerModule(d),v.socketRegisterToggleLightHidden(),v.socketRegisterAddClickHandler()}),l(v,"socketRegisterToggleLightHidden",()=>{const e=socketlib.modules.get(d);e&&e.register("toggleLightHidden",t=>{var c,o;s.log("Chached the event");const n=(o=(c=game.canvas)==null?void 0:c.lighting)==null?void 0:o.get(t);return n?(s.log("Updating light document"),n.document.update({hidden:!n.document.hidden})):!1})}),l(v,"socketRegisterAddClickHandler",()=>{const e=socketlib.modules.get(d);e&&e.register("addClickHandler",(t,n)=>{var o,a;const c=(a=(o=game.canvas)==null?void 0:o.tokens)==null?void 0:a.get(t);s.log(c),c&&S.addEventHandler(c)})}),l(v,"toggleLightHidden",async e=>{var n,c,o;if(!e)return;const t=(c=(n=game.canvas)==null?void 0:n.lighting)==null?void 0:c.get(e);if(t){if(s.log("Found light",t),(o=game.user)!=null&&o.isGM){s.log("GM's click, allow to change the light"),await t.document.update({hidden:!t.document.hidden});return}if(s.log("User's click, sending the request to the server"),s.log("sending the request to the server"),s.log(socketlib),s.log(socketlib.modules),socketlib.modules.get(d)){const a=socketlib.modules.get(d);if(!a)return;a.executeAsGM("toggleLightHidden",e)}else s.error(`Couldn't find a registered module ${d}`);s.log(socketlib.modules)}});let U=v;class S{static init(){this.setupTokenClickHandler()}static setupTokenClickHandler(){var t,n,c;const e=((c=(n=(t=game.canvas)==null?void 0:t.tokens)==null?void 0:n.objects)==null?void 0:c.children).filter(o=>o.document.getFlag(d,N)).map(o=>(this.addEventHandler(o),o));s.log("Retriving tokens linked to a light object",e)}static addEventHandlerById(e){var n,c;const t=(c=(n=game.canvas)==null?void 0:n.tokens)==null?void 0:c.get(e);t&&this.addEventHandler(t)}static addEventHandler(e){e.onclick=this.handleTokenClick}static async handleTokenClick(e){var c;const t=e.currentTarget;if(!t)return!0;const n=t.document.getFlag(d,N);return n?(await U.toggleLightHidden(n),s.log(`Token clicked by ${(c=game.user)==null?void 0:c.name}`,{token:t.id,light:n,user:game.userId}),!1):!0}}l(S,"HOOK_NAME","leftClickToken"),l(S,"hookId");const h=class h{};l(h,"updateTextureSource",async(e,t,n)=>{var o,a,u;if(!((o=game.user)!=null&&o.isGM)||!e)return!1;const c=(u=(a=game.canvas)==null?void 0:a.tokens)==null?void 0:u.get(e);if(s.log(c),!c)return s.warn(`Token with ID ${e} not found`),!1;try{return s.log(`UPDATING TOKEN ${e} TEXTURE SOURCE`),await c.document.update({texture:{src:n}}),await c.document.setFlag(d,N,t),!0}catch(p){return s.error(`Failed to update token ${e}:`,p),!1}}),l(h,"deleteTokenHook",async(e,t,n)=>{var c,o;if(e.getFlag(d,N)){const a=(c=e.actor)==null?void 0:c.id;if(a){const u=(o=game.actors)==null?void 0:o.get(a);u&&(s.log(`DELETING ASSOCIATED ACTOR: ${a}`),await u.delete())}}}),l(h,"delete",async(e,t=null)=>{var n,c,o,a,u,p;if((n=game.user)!=null&&n.isGM){if(e){const g=(c=game.scenes.current)==null?void 0:c.tokens.get(e),k=(a=(o=game.canvas)==null?void 0:o.tokens)==null?void 0:a.get(e);g&&(s.log(`DELETING TOKEN: ${e}`),k&&((p=(u=game.canvas)==null?void 0:u.tokens)==null||p.removeChild(k)),await g.delete())}t&&(t.setFlag(d,H,e),t.setFlag(d,F,""))}}),l(h,"createActor",async e=>{var c;if(!((c=game.user)!=null&&c.isGM))return;const t=await A.getFolder();return await Actor.create({name:`light-${e}`,type:"base",folder:t.id})}),l(h,"createActorToken",async(e,t,n,c)=>{var p,g,k,j,P;if(!(c!=null&&c.id))return;const o=await h.createActor(c.id);if(!o)return;s.log("light pos",`${t} : ${n}`);const a=await TokenDocument.create({name:o.name,actorId:o.id,x:t,y:n,width:1,height:1,disposition:CONST.TOKEN_DISPOSITIONS.SECRET,texture:{src:e,anchorX:.5,anchorY:.5}},{parent:canvas.scene});if(s.log("Token doc created",a),!a)return;a==null||a.update({movementAction:"blink"});const u=(g=(p=game.canvas)==null?void 0:p.tokens)==null?void 0:g.get(a.id);if(u){u.onclick=S.handleTokenClick,s.log("Tocken created",(j=(k=game.canvas)==null?void 0:k.tokens)==null?void 0:j.get(a.id));const q=socketlib.modules.get(d);q&&((P=game.users)==null||P.forEach(D=>{!D.isGM&&D.active&&q.executeAsUser("addClickHandler",D.id,u.id)}))}return await a.setFlag(d,N,c.id),await c.setFlag(d,H,a.id),a}),l(h,"changeTokenPositions",async(e,t,n)=>{var a,u,p;if(!((a=game.user)!=null&&a.isGM))return!1;const c=(p=(u=game.canvas)==null?void 0:u.tokens)==null?void 0:p.get(e);if(!c)return s.log(`Couldn't find a token with id ${e}`),!1;const o={};if(t===0||t){const g=h.culcObjPosition(t,"X");o.x=g,s.log(`POS X UPDATED: ${g}`)}if(n===0||n){const g=h.culcObjPosition(n,"Y");o.y=g,s.log(`POS Y UPDATED: ${g}`)}if(Object.keys(o).length>0)try{await c.document.update(o)}catch(g){s.error(`Unnable to update token [${e}]`),console.log(g)}return!0}),l(h,"culcObjPosition",(e,t)=>e-h.getTileSize(t)/2),l(h,"getTileSize",e=>{switch(e){case"X":return se;case"Y":return oe}});let m=h;function $(i,e){return i.replace(/\${(\w+)}/g,(t,n)=>e[n]!==void 0?String(e[n]):"")}var T,K,I;const r=class r{};T=new WeakMap,K=new WeakMap,I=new WeakMap,x(r,T,"chekbox-input"),x(r,K,"text-input"),x(r,I,"${appId}.${flagPath}.${type}"),l(r,"trackLightPositionHook",(e,t)=>{if(s.log("========================================================="),s.log("---------------------------------------------------------"),s.log("AmbientLight updated!",document,t,"x"in t,"y"in t,"x"in t||"y"in t),"x"in t||"y"in t){s.log("Light position changed:",t.x,t.y);const n=e.getFlag(d,z),c=e.getFlag(d,H);if(s.log(`tokenId: ${c}`),!n||!c)return;m.changeTokenPositions(c,t.x,t.y)||(e.setFlag(d,H,""),e.setFlag(d,F,""))}}),l(r,"deleteAmbientLightHook",async(e,t,n)=>{s.log(`AMBIENT LIGHT ${e.id} WAS DELETED`);const c=e.getFlag(d,H);c&&await m.delete(c,null)}),l(r,"renderLightConfigHook",(e,t,n,c)=>{if(c&&!c.isFirstRender)return;const o=e.document,a=o.getFlag(d,z)??!1,u=r.createInteractiveCheckboxHtmlElement(e.id,a),p=o.getFlag(d,F),g=r.createInteractivePathHtmlElement(e.id,p,a),k=t.querySelector('[data-application-part="advanced"]');k==null||k.appendChild(u),k==null||k.appendChild(g),t.onsubmit=r.onConfigSubmit}),l(r,"createInteractiveCheckboxHtmlElement",(e,t)=>{const n=document.createElement("div");n.className="form-group";const c=document.createElement("label");c.innerText=game.i18n.localize(te);const o=document.createElement("div");o.className="form-fields";const a=document.createElement("input");a.type="checkbox",a.name=y,a.checked=t,a.id=$(f(r,I),{appId:e,flagPath:y,type:f(r,T)}),a.onchange=r.onInteractiveCheckboxChanged;const u=document.createElement("p");return u.className="hint",u.innerText=game.i18n.localize(ce),o.appendChild(a),n.appendChild(c),n.appendChild(o),n.appendChild(u),n}),l(r,"createInteractivePathHtmlElement",(e,t,n)=>{const c=document.createElement("div");c.className="form-group",c.id=$(f(r,I),{appId:e,flagPath:E,type:"form-group"}),c.hidden=!n;const o=document.createElement("label");o.htmlFor=E,o.innerText=game.i18n.localize(ae);const a=document.createElement("div");return a.className="form-fields",a.innerHTML=`<file-picker name="${E}" type="image" id="${e}-${E}" value="${t??""}"></file-picker>`,c.appendChild(o),c.appendChild(a),c}),l(r,"onInteractiveCheckboxChanged",e=>{const t=e.target;if(!t)return;const n=t.id.slice(0,t.id.indexOf($(f(r,I),{appId:"",flagPath:y,type:f(r,T)}))),c=t.checked,o=document.getElementById($(f(r,I),{appId:n,flagPath:E,type:"form-group"}));o&&(o.hidden=!c)}),l(r,"onConfigSubmit",async e=>{var k;s.log("AMBIENT LIGHT CONFIGURATION SUBMITTED");const t=r.getInteractiveCheckbox(e.target),n=r.getPathInput(e.target),o=r.getAppIdFromInteractiveCheckbox(t).split("-").pop();if(!o)return;const a=(k=canvas.lighting)==null?void 0:k.get(o);if(!a)return;const u=a.document.getFlag(d,H),g=n.value||a.document.getFlag(d,F)||ne;if(t.checked){if(await m.updateTextureSource(u,o,g))return;s.log("CREATING TOKEN"),m.createActorToken(g,m.culcObjPosition(a.position._x,"X"),m.culcObjPosition(a.position._y,"Y"),a.document).then(P=>{s.log("DATA",P)})}else m.delete(u,a.document)}),l(r,"getInteractiveCheckbox",e=>e.querySelector(`[name="${y}"]`)),l(r,"getPathInput",e=>e.querySelector(`[name="${E}"]`)),l(r,"getAppIdFromInteractiveCheckbox",e=>e.id.slice(0,e.id.indexOf($(f(r,I),{appId:"",flagPath:y,type:f(r,T)}))));let w=r;function ie(){Hooks.once("init",re),Hooks.once("ready",Z)}function re(i){var e,t;Hooks.on("ready",Z),Hooks.on("renderAmbientLightConfig",w.renderLightConfigHook),Hooks.on("updateAmbientLight",w.trackLightPositionHook),Hooks.on("deleteAmbientLight",w.deleteAmbientLightHook),Hooks.on("deleteToken",m.deleteTokenHook),(t=(e=game.modules)==null?void 0:e.get("socketlib"))!=null&&t.active||s.error("Socketlib is not active!"),U.init()}function Z(){S.init()}s.minLogLevel=Q.debug;ie();
