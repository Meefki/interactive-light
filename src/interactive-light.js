var L=Object.defineProperty;var Y=i=>{throw TypeError(i)};var _=(i,e,t)=>e in i?L(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var l=(i,e,t)=>_(i,typeof e!="symbol"?e+"":e,t),ee=(i,e,t)=>e.has(i)||Y("Cannot "+t);var f=(i,e,t)=>(ee(i,e,"read from private field"),t?t.call(i):e.get(i)),G=(i,e,t)=>e.has(i)?Y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t);const Q="flags",d="interactive-light",A="interactive",N="path",T="token-id",$=`${Q}.${d}.${A}`,H=`${Q}.${d}.${N}`,w="light-id",B="INTERACTIVE_LIGHT",te=`${B}.Enabled`,ce=`${B}.EnabledHint`,ae=`${B}.Path`,ne=CONST.DEFAULT_TOKEN;var W,M;const oe=((M=(W=game.canvas)==null?void 0:W.grid)==null?void 0:M.size)??100;var V,J;const se=((J=(V=game.canvas)==null?void 0:V.grid)==null?void 0:J.size)??100,C="InteractiveLight",S=class S{};l(S,"getFolder",async()=>{var t;let e=(t=game.folders)==null?void 0:t.getName(C);return e||(e=await S.createFolder()),e}),l(S,"createFolder",async()=>await Folder.create({name:C,type:"Actor"}));let K=S;const b="color: #7bf542",R="color: #d8eb34",U="color: #ffffff";var Z=(i=>(i[i.debug=0]="debug",i[i.info=1]="info",i[i.warn=2]="warn",i[i.error=3]="error",i))(Z||{});class s{static log(...e){this.minLogLevel>0||console.log("%c Interactive%cLight %c",b,R,U,...e)}static info(...e){this.minLogLevel>1||console.info("%c Interactive%cLight %c",b,R,U,...e)}static warn(...e){this.minLogLevel>2||console.warn("%c Interactive%cLight %c",b,R,U,...e)}static error(...e){this.minLogLevel>3||console.error("%c Interactive%cLight %c",b,R,U,...e)}}l(s,"minLogLevel",2);const v=class v{};l(v,"init",()=>{socketlib.registerModule(d),v.socketRegisterToggleLightHidden(),v.socketRegisterAddClickHandler()}),l(v,"socketRegisterToggleLightHidden",()=>{const e=socketlib.modules.get(d);e&&e.register("toggleLightHidden",t=>{var c,a;s.log("Chached the event");const o=(a=(c=game.canvas)==null?void 0:c.lighting)==null?void 0:a.get(t);return o?(s.log("Updating light document"),o.document.update({hidden:!o.document.hidden})):!1})}),l(v,"socketRegisterAddClickHandler",()=>{const e=socketlib.modules.get(d);e&&e.register("addClickHandler",(t,o)=>{var a,n;const c=(n=(a=game.canvas)==null?void 0:a.tokens)==null?void 0:n.get(t);s.log(c),c&&P.addEventHandler(c)})}),l(v,"toggleLightHidden",async e=>{var o,c,a;if(!e)return;const t=(c=(o=game.canvas)==null?void 0:o.lighting)==null?void 0:c.get(e);if(t){if(s.log("Found light",t),(a=game.user)!=null&&a.isGM){s.log("GM's click, allow to change the light"),await t.document.update({hidden:!t.document.hidden});return}if(s.log("User's click, sending the request to the server"),s.log("sending the request to the server"),s.log(socketlib),s.log(socketlib.modules),socketlib.modules.get(d)){const n=socketlib.modules.get(d);if(!n)return;n.executeAsGM("toggleLightHidden",e)}else s.error(`Couldn't find a registered module ${d}`);s.log(socketlib.modules)}});let j=v;const I=class I{static addEventHandlerById(e){var o,c;const t=(c=(o=game.canvas)==null?void 0:o.tokens)==null?void 0:c.get(e);t&&this.addEventHandler(t)}static addEventHandler(e){e.onclick=this.handleTokenClick}static async handleTokenClick(e){var c;const t=e.currentTarget;if(!t)return!0;const o=t.document.getFlag(d,w);return o?(await j.toggleLightHidden(o),s.log(`Token clicked by ${(c=game.user)==null?void 0:c.name}`,{token:t.id,light:o,user:game.userId}),!1):!0}};l(I,"HOOK_NAME","leftClickToken"),l(I,"init",()=>{I.setupTokenClickHandler()}),l(I,"setupTokenClickHandler",()=>{var t,o,c;s.log("Initializing light tokens...");const e=((c=(o=(t=game.canvas)==null?void 0:t.tokens)==null?void 0:o.objects)==null?void 0:c.children).filter(a=>a.document.getFlag(d,w)).map(a=>(s.info("Add click event candler to",a),I.addEventHandler(a),a));s.log("Retriving tokens linked to a light object",e)});let P=I;const h=class h{};l(h,"updateTextureSource",async(e,t,o)=>{var a,n,u;if(!((a=game.user)!=null&&a.isGM)||!e)return!1;const c=(u=(n=game.canvas)==null?void 0:n.tokens)==null?void 0:u.get(e);if(s.log(c),!c)return s.warn(`Token with ID ${e} not found`),!1;try{return s.log(`UPDATING TOKEN ${e} TEXTURE SOURCE`),await c.document.update({texture:{src:o}}),await c.document.setFlag(d,w,t),!0}catch(p){return s.error(`Failed to update token ${e}:`,p),!1}}),l(h,"deleteTokenHook",async(e,t,o)=>{var c,a;if(e.getFlag(d,w)){const n=(c=e.actor)==null?void 0:c.id;if(n){const u=(a=game.actors)==null?void 0:a.get(n);u&&(s.log(`DELETING ASSOCIATED ACTOR: ${n}`),await u.delete())}}}),l(h,"delete",async(e,t=null)=>{var o,c,a,n,u,p;if((o=game.user)!=null&&o.isGM){if(e){const g=(c=game.scenes.current)==null?void 0:c.tokens.get(e),k=(n=(a=game.canvas)==null?void 0:a.tokens)==null?void 0:n.get(e);g&&(s.log(`DELETING TOKEN: ${e}`),k&&((p=(u=game.canvas)==null?void 0:u.tokens)==null||p.removeChild(k)),await g.delete())}t&&(t.setFlag(d,T,e),t.setFlag(d,N,""))}}),l(h,"createActor",async e=>{var c;if(!((c=game.user)!=null&&c.isGM))return;const t=await K.getFolder();return await Actor.create({name:`light-${e}`,type:"base",folder:t.id})}),l(h,"createActorToken",async(e,t,o,c)=>{var p,g,k,z,x;if(!(c!=null&&c.id))return;const a=await h.createActor(c.id);if(!a)return;s.log("light pos",`${t} : ${o}`);const n=await TokenDocument.create({name:a.name,actorId:a.id,x:t,y:o,width:1,height:1,disposition:CONST.TOKEN_DISPOSITIONS.SECRET,texture:{src:e,anchorX:.5,anchorY:.5}},{parent:canvas.scene});if(s.log("Token doc created",n),!n)return;n==null||n.update({movementAction:"blink"});const u=(g=(p=game.canvas)==null?void 0:p.tokens)==null?void 0:g.get(n.id);if(u){u.onclick=P.handleTokenClick,s.log("Tocken created",(z=(k=game.canvas)==null?void 0:k.tokens)==null?void 0:z.get(n.id));const X=socketlib.modules.get(d);X&&((x=game.users)==null||x.forEach(D=>{!D.isGM&&D.active&&X.executeAsUser("addClickHandler",D.id,u.id)}))}return await n.setFlag(d,w,c.id),await c.setFlag(d,T,n.id),n}),l(h,"changeTokenPositions",async(e,t,o)=>{var n,u,p;if(!((n=game.user)!=null&&n.isGM))return!1;const c=(p=(u=game.canvas)==null?void 0:u.tokens)==null?void 0:p.get(e);if(!c)return s.log(`Couldn't find a token with id ${e}`),!1;const a={};if(t===0||t){const g=h.culcObjPosition(t,"X");a.x=g,s.log(`POS X UPDATED: ${g}`)}if(o===0||o){const g=h.culcObjPosition(o,"Y");a.y=g,s.log(`POS Y UPDATED: ${g}`)}if(Object.keys(a).length>0)try{await c.document.update(a)}catch(g){s.error(`Unnable to update token [${e}]`),console.log(g)}return!0}),l(h,"culcObjPosition",(e,t)=>e-h.getTileSize(t)/2),l(h,"getTileSize",e=>{switch(e){case"X":return se;case"Y":return oe}});let m=h;function F(i,e){return i.replace(/\${(\w+)}/g,(t,o)=>e[o]!==void 0?String(e[o]):"")}var y,q,E;const r=class r{};y=new WeakMap,q=new WeakMap,E=new WeakMap,G(r,y,"chekbox-input"),G(r,q,"text-input"),G(r,E,"${appId}.${flagPath}.${type}"),l(r,"trackLightPositionHook",(e,t)=>{if(s.log("========================================================="),s.log("---------------------------------------------------------"),s.log("AmbientLight updated!",document,t,"x"in t,"y"in t,"x"in t||"y"in t),"x"in t||"y"in t){s.log("Light position changed:",t.x,t.y);const o=e.getFlag(d,A),c=e.getFlag(d,T);if(s.log(`tokenId: ${c}`),!o||!c)return;m.changeTokenPositions(c,t.x,t.y)||(e.setFlag(d,T,""),e.setFlag(d,N,""))}}),l(r,"deleteAmbientLightHook",async(e,t,o)=>{s.log(`AMBIENT LIGHT ${e.id} WAS DELETED`);const c=e.getFlag(d,T);c&&await m.delete(c,null)}),l(r,"renderLightConfigHook",(e,t,o,c)=>{if(c&&!c.isFirstRender)return;const a=e.document,n=a.getFlag(d,A)??!1,u=r.createInteractiveCheckboxHtmlElement(e.id,n),p=a.getFlag(d,N),g=r.createInteractivePathHtmlElement(e.id,p,n),k=t.querySelector('[data-application-part="advanced"]');k==null||k.appendChild(u),k==null||k.appendChild(g),t.onsubmit=r.onConfigSubmit}),l(r,"createInteractiveCheckboxHtmlElement",(e,t)=>{const o=document.createElement("div");o.className="form-group";const c=document.createElement("label");c.innerText=game.i18n.localize(te);const a=document.createElement("div");a.className="form-fields";const n=document.createElement("input");n.type="checkbox",n.name=$,n.checked=t,n.id=F(f(r,E),{appId:e,flagPath:$,type:f(r,y)}),n.onchange=r.onInteractiveCheckboxChanged;const u=document.createElement("p");return u.className="hint",u.innerText=game.i18n.localize(ce),a.appendChild(n),o.appendChild(c),o.appendChild(a),o.appendChild(u),o}),l(r,"createInteractivePathHtmlElement",(e,t,o)=>{const c=document.createElement("div");c.className="form-group",c.id=F(f(r,E),{appId:e,flagPath:H,type:"form-group"}),c.hidden=!o;const a=document.createElement("label");a.htmlFor=H,a.innerText=game.i18n.localize(ae);const n=document.createElement("div");return n.className="form-fields",n.innerHTML=`<file-picker name="${H}" type="image" id="${e}-${H}" value="${t??""}"></file-picker>`,c.appendChild(a),c.appendChild(n),c}),l(r,"onInteractiveCheckboxChanged",e=>{const t=e.target;if(!t)return;const o=t.id.slice(0,t.id.indexOf(F(f(r,E),{appId:"",flagPath:$,type:f(r,y)}))),c=t.checked,a=document.getElementById(F(f(r,E),{appId:o,flagPath:H,type:"form-group"}));a&&(a.hidden=!c)}),l(r,"onConfigSubmit",async e=>{var k;s.log("AMBIENT LIGHT CONFIGURATION SUBMITTED");const t=r.getInteractiveCheckbox(e.target),o=r.getPathInput(e.target),a=r.getAppIdFromInteractiveCheckbox(t).split("-").pop();if(!a)return;const n=(k=canvas.lighting)==null?void 0:k.get(a);if(!n)return;const u=n.document.getFlag(d,T),g=o.value||n.document.getFlag(d,N)||ne;if(t.checked){if(await m.updateTextureSource(u,a,g))return;s.log("CREATING TOKEN"),m.createActorToken(g,m.culcObjPosition(n.position._x,"X"),m.culcObjPosition(n.position._y,"Y"),n.document).then(x=>{s.log("DATA",x)})}else m.delete(u,n.document)}),l(r,"getInteractiveCheckbox",e=>e.querySelector(`[name="${$}"]`)),l(r,"getPathInput",e=>e.querySelector(`[name="${H}"]`)),l(r,"getAppIdFromInteractiveCheckbox",e=>e.id.slice(0,e.id.indexOf(F(f(r,E),{appId:"",flagPath:$,type:f(r,y)}))));let O=r;function ie(){Hooks.once("init",re),Hooks.once("ready",le)}function re(i){var e,t;Hooks.on("canvasReady",P.init),Hooks.on("renderAmbientLightConfig",O.renderLightConfigHook),Hooks.on("updateAmbientLight",O.trackLightPositionHook),Hooks.on("deleteAmbientLight",O.deleteAmbientLightHook),Hooks.on("deleteToken",m.deleteTokenHook),(t=(e=game.modules)==null?void 0:e.get("socketlib"))!=null&&t.active||s.error("Socketlib is not active!"),j.init()}function le(){}s.minLogLevel=Z.debug;ie();
