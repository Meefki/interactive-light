var W=Object.defineProperty;var D=l=>{throw TypeError(l)};var Y=(l,t,e)=>t in l?W(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var d=(l,t,e)=>Y(l,typeof t!="symbol"?t+"":t,e),V=(l,t,e)=>t.has(l)||D("Cannot "+e);var m=(l,t,e)=>(V(l,t,"read from private field"),e?e.call(l):t.get(l)),F=(l,t,e)=>t.has(l)?D("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(l):t.set(l,e);const X="flags",u="interactive-light",N="interactive",x="path",f="tile-id",k=`${X}.${u}.${N}`,E=`${X}.${u}.${x}`,y="light-id",j="";var z,U;const R=((U=(z=game.canvas)==null?void 0:z.grid)==null?void 0:U.size)??100;var M,B;const O=((B=(M=game.canvas)==null?void 0:M.grid)==null?void 0:B.size)??100,J="color: #7bf542",K="color: #d8eb34",Q="color: #ffffff";class i{static log(...t){console.log("%c Interactive%cLight %c",J,K,Q,...t)}}class S{}d(S,"switchLight",t=>{i.log(t)});const p=class p{static deleteTile(t,e){var n,a,o,c;if(t){const r=(a=(n=game.canvas)==null?void 0:n.tiles)==null?void 0:a.get(t);r&&(i.log(`DELETING TILE: ${t}`),(c=(o=game.canvas)==null?void 0:o.tiles)==null||c.removeChild(r),r.document.delete())}e&&(e.setFlag(u,f,t),e.setFlag(u,x,""))}};d(p,"updateTileTextureSource",(t,e,n)=>{var a,o;if(t){const c=(o=(a=game.canvas)==null?void 0:a.tiles)==null?void 0:o.get(t);if(i.log(c),c)return i.log(`UPDATING TILE ${t} TEXTURE SOURCE`),c.document.setFlag(u,y,e),c.document.update({texture:{src:n}}),!0}return!1}),d(p,"createTile",async(t,e,n,a)=>{var r;i.log("CREATING NEW TILE");const o=await TileDocument.create({height:R,width:O,x:e,y:n,texture:{src:t,anchorX:.5,anchorY:.5}},{parent:canvas.scene});if(i.log(o),!o)return;o.setFlag(u,y,a.id),a.setFlag(u,f,o.id);const c=(r=canvas.tiles)==null?void 0:r.get(o._id);return c&&(c.interactive=!0,c.on("pointerdown",H=>{i.log("clicked"),S.switchLight(H)})),i.log(c),i.log(`TILE DOC CREATED: ${o.id}`),o}),d(p,"changeTilePositions",(t,e,n)=>{var o,c;const a=(c=(o=game.canvas)==null?void 0:o.tiles)==null?void 0:c.get(t);if(!a)return i.log(`Couldn't find a tile with id ${t}`),!1;if(e==0||e){const r=p.culcTilePosition(e,"X");a.document.update({x:r}),i.log(`POS X UPDATED: ${r}`)}if(n==0||n){const r=p.culcTilePosition(n,"Y");a.document.update({y:r}),i.log(`POS Y UPDATED: ${r}`)}return!0}),d(p,"culcTilePosition",(t,e)=>t-p.getTileSize(e)/2),d(p,"getTileSize",t=>{switch(t){case"X":return O;case"Y":return R}}),d(p,"registerTileClickEvent",t=>{var n;if(i.log("Register Tile click event",t),!t.getFlag(u,y)||!t.id)return;const e=(n=canvas.tiles)==null?void 0:n.get(t.id);e&&(e.interactive=!0,e.eventMode="static",e.on("pointerdown",S.switchLight),i.log(e))});let h=p;const w="INTERACTIVE_LIGHT",Z=`${w}.Enabled`,C=`${w}.EnabledHint`,b=`${w}.Path`;function v(l,t){return l.replace(/\${(\w+)}/g,(e,n)=>t[n]!==void 0?String(t[n]):"")}var T,G,I;const s=class s{};T=new WeakMap,G=new WeakMap,I=new WeakMap,F(s,T,"chekbox-input"),F(s,G,"text-input"),F(s,I,"${appId}.${flagPath}.${type}"),d(s,"trackLightPositionHook",(t,e)=>{if(i.log("========================================================="),i.log("---------------------------------------------------------"),i.log("AmbientLight updated!",document,e,"x"in e,"y"in e,"x"in e||"y"in e),"x"in e||"y"in e){i.log("Light position changed:",e.x,e.y);const n=t.getFlag(u,N),a=t.getFlag(u,f);if(i.log(`tileId: ${a}`),!n||!a)return;h.changeTilePositions(a,e.x,e.y)||(t.setFlag(u,f,""),t.setFlag(u,x,""))}}),d(s,"deleteAmbientLightHook",(t,e,n)=>{i.log(`AMBIENT LIGHT ${t.id} WAS DELETED`);const a=t.getFlag(u,f);a&&h.deleteTile(a,null)}),d(s,"renderLightConfigHook",(t,e,n,a)=>{if(a&&!a.isFirstRender)return;const o=t.document,c=o.getFlag(u,N)??!1,r=s.createInteractiveCheckboxHtmlElement(t.id,c),H=o.getFlag(u,x),P=s.createInteractivePathHtmlElement(t.id,H,c),g=e.querySelector('[data-application-part="advanced"]');g==null||g.appendChild(r),g==null||g.appendChild(P),e.onsubmit=s.onConfigSubmit}),d(s,"createInteractiveCheckboxHtmlElement",(t,e)=>{const n=document.createElement("div");n.className="form-group";const a=document.createElement("label");a.innerText=game.i18n.localize(Z);const o=document.createElement("div");o.className="form-fields";const c=document.createElement("input");c.type="checkbox",c.name=k,c.checked=e,c.id=v(m(s,I),{appId:t,flagPath:k,type:m(s,T)}),c.onchange=s.onInteractiveCheckboxChanged;const r=document.createElement("p");return r.className="hint",r.innerText=game.i18n.localize(C),o.appendChild(c),n.appendChild(a),n.appendChild(o),n.appendChild(r),n}),d(s,"createInteractivePathHtmlElement",(t,e,n)=>{const a=document.createElement("div");a.className="form-group",a.id=v(m(s,I),{appId:t,flagPath:E,type:"form-group"}),a.hidden=!n;const o=document.createElement("label");o.htmlFor=E,o.innerText=game.i18n.localize(b);const c=document.createElement("div");return c.className="form-fields",c.innerHTML=`<file-picker name="${E}" type="image" id="${t}-${E}" value="${e??""}"></file-picker>`,a.appendChild(o),a.appendChild(c),a}),d(s,"onInteractiveCheckboxChanged",t=>{const e=t.target;if(!e)return;const n=e.id.slice(0,e.id.indexOf(v(m(s,I),{appId:"",flagPath:k,type:m(s,T)}))),a=e.checked,o=document.getElementById(v(m(s,I),{appId:n,flagPath:E,type:"form-group"}));o&&(o.hidden=!a)}),d(s,"onConfigSubmit",t=>{var g;i.log("AMBIENT LIGHT CONFIGURATION SUBMITTED");const e=s.getInteractiveCheckbox(t.target),n=s.getPathInput(t.target),o=s.getAppIdFromInteractiveCheckbox(e).split("-").pop();if(!o)return;const c=(g=canvas.lighting)==null?void 0:g.get(o);if(!c)return;const r=c.document.getFlag(u,f),P=n.value||c.document.getFlag(u,x)||j;if(e.checked){if(h.updateTileTextureSource(r,o,P))return;i.log("CREATING TILE"),h.createTile(P,h.culcTilePosition(c.position._x,"X"),h.culcTilePosition(c.position._y,"Y"),c.document).then(q=>{i.log("DATA",q)})}else h.deleteTile(r,c.document)}),d(s,"getInteractiveCheckbox",t=>t.querySelector(`[name="${k}"]`)),d(s,"getPathInput",t=>t.querySelector(`[name="${E}"]`)),d(s,"getAppIdFromInteractiveCheckbox",t=>t.id.slice(0,t.id.indexOf(v(m(s,I),{appId:"",flagPath:k,type:m(s,T)}))));let $=s;function L(){Hooks.once("init",A)}function A(l){Hooks.on("ready",_),Hooks.on("renderAmbientLightConfig",$.renderLightConfigHook),Hooks.on("updateAmbientLight",$.trackLightPositionHook),Hooks.on("deleteAmbientLight",$.deleteAmbientLightHook),Hooks.on("createTile",h.registerTileClickEvent)}function _(){}L();
