var J=Object.defineProperty;var K=d=>{throw TypeError(d)};var Q=(d,e,t)=>e in d?J(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var r=(d,e,t)=>Q(d,typeof e!="symbol"?e+"":e,t),Z=(d,e,t)=>e.has(d)||K("Cannot "+t);var m=(d,e,t)=>(Z(d,e,"read from private field"),t?t.call(d):e.get(d)),G=(d,e,t)=>e.has(d)?K("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(d):e.set(d,t);const W="flags",l="interactive-light",M="interactive",N="path",T="token-id",$=`${W}.${l}.${M}`,H=`${W}.${l}.${N}`,R="light-id",C="INTERACTIVE_LIGHT",L=`${C}.Enabled`,_=`${C}.EnabledHint`,ee=`${C}.Path`,te=CONST.DEFAULT_TOKEN;var q,B;const ce=((B=(q=game.canvas)==null?void 0:q.grid)==null?void 0:B.size)??100;var X,Y;const ne=((Y=(X=game.canvas)==null?void 0:X.grid)==null?void 0:Y.size)??100,ae=!0,x="color: #7bf542",P="color: #d8eb34",b="color: #ffffff";class s{static log(...e){this.minLogLevel>0||console.log("%c Interactive%cLight %c",x,P,b,...e)}static info(...e){this.minLogLevel>1||console.info("%c Interactive%cLight %c",x,P,b,...e)}static warn(...e){this.minLogLevel>2||console.warn("%c Interactive%cLight %c",x,P,b,...e)}static error(...e){this.minLogLevel>3||console.error("%c Interactive%cLight %c",x,P,b,...e)}}r(s,"minLogLevel",0);const k=class k{};r(k,"updateTextureSource",async(e,t,n)=>{var a,o,u;if(!((a=game.user)!=null&&a.isGM)||!e)return!1;const c=(u=(o=game.canvas)==null?void 0:o.tokens)==null?void 0:u.get(e);if(s.log(c),!c)return s.warn(`Token with ID ${e} not found`),!1;try{return ae&&s.log(`UPDATING TOKEN ${e} TEXTURE SOURCE`),await c.document.update({texture:{src:n}}),await c.document.setFlag(l,R,t),!0}catch(p){return s.error(`Failed to update token ${e}:`,p),!1}}),r(k,"delete",async(e,t)=>{var n,c,a,o,u,p,g;if((n=game.user)!=null&&n.isGM){if(e){const h=(a=(c=game.canvas)==null?void 0:c.tokens)==null?void 0:a.get(e);if(h){s.log(`DELETING TOKEN: ${e}`);const w=(o=h.actor)==null?void 0:o.id;if((p=(u=game.canvas)==null?void 0:u.tokens)==null||p.removeChild(h),await h.document.delete(),w){const E=(g=game.actors)==null?void 0:g.get(w);E&&(s.log(`DELETING ASSOCIATED ACTOR: ${w}`),await E.delete())}}}t&&(t.setFlag(l,T,e),t.setFlag(l,N,""))}}),r(k,"createActor",async e=>{var n;return(n=game.user)!=null&&n.isGM?await Actor.create({name:`light-${e}`,type:"base"}):void 0}),r(k,"createActorToken",async(e,t,n,c)=>{var u;if(!((u=game.user)!=null&&u.isGM)||!(c!=null&&c.id))return;const a=await k.createActor(c.id);if(!a)return;s.log("light pos",`${t} : ${n}`);const o=await TokenDocument.create({name:a.name,actorId:a.id,x:t,y:n,width:1,height:1,disposition:CONST.TOKEN_DISPOSITIONS.SECRET,texture:{src:e,anchorX:.5,anchorY:.5}},{parent:canvas.scene});if(s.log("Token created",o),!!o)return o==null||o.update({movementAction:"blink"}),await o.setFlag(l,R,c.id),await c.setFlag(l,T,o.id),o}),r(k,"changeTokenPositions",async(e,t,n)=>{var o,u,p;if(!((o=game.user)!=null&&o.isGM))return!1;const c=(p=(u=game.canvas)==null?void 0:u.tokens)==null?void 0:p.get(e);if(!c)return s.log(`Couldn't find a token with id ${e}`),!1;const a={};if(t===0||t){const g=k.culcObjPosition(t,"X");a.x=g,s.log(`POS X UPDATED: ${g}`)}if(n===0||n){const g=k.culcObjPosition(n,"Y");a.y=g,s.log(`POS Y UPDATED: ${g}`)}if(Object.keys(a).length>0)try{await c.document.update(a)}catch(g){s.error(`Unnable to update token [${e}]`),console.log(g)}return!0}),r(k,"culcObjPosition",(e,t)=>e-k.getTileSize(t)/2),r(k,"getTileSize",e=>{switch(e){case"X":return ne;case"Y":return ce}});let f=k;const v=class v{};r(v,"init",()=>{socketlib.registerModule(l),v.socketRegisterToggleLightHidden(),v.socketRegisterAddClickHandler()}),r(v,"socketRegisterToggleLightHidden",()=>{socketlib.modules.get(l).register("toggleLightHidden",t=>{var c,a;s.log("Chached the event");const n=(a=(c=game.canvas)==null?void 0:c.lighting)==null?void 0:a.get(t);return n?(s.log("Updating light document"),n.document.update({hidden:!n.document.hidden})):!1})}),r(v,"socketRegisterAddClickHandler",()=>{socketlib.modules.get(l).register("addClickHandler",(t,n)=>{var a,o;const c=(o=(a=game.canvas)==null?void 0:a.tokens)==null?void 0:o.get(t);s.log(c),c&&S.addEventHandler(c)})}),r(v,"toggleLightHidden",async e=>{var n,c,a;if(!e)return;const t=(c=(n=game.canvas)==null?void 0:n.lighting)==null?void 0:c.get(e);if(t){if(s.log("Found light",t),(a=game.user)!=null&&a.isGM){s.log("GM's click, allow to change the light"),await t.document.update({hidden:!t.document.hidden});return}s.log("User's click, sending the request to the server"),s.log("sending the request to the server"),s.log(socketlib),s.log(socketlib.modules),socketlib.modules.get(l)?socketlib.modules.get(l).executeAsGM("toggleLightHidden",e):s.error(`Couldn't find a registered module ${l}`),s.log(socketlib.modules)}});let U=v;class S{static init(){this.setupTokenClickHandler()}static setupTokenClickHandler(){var t,n,c;const e=((c=(n=(t=game.canvas)==null?void 0:t.tokens)==null?void 0:n.objects)==null?void 0:c.children).filter(a=>a.document.getFlag(l,R)).map(a=>this.addEventHandler(a));s.log("Retriving tokens linked to a light object",e)}static addEventHandler(e){var t;if((t=game.user)!=null&&t.isGM){e.onclick=this.handleTokenClick;const n=socketlib.modules.get(l);if(s.log("Socket",n),!n)return;game.users.forEach(c=>{c.isGM||(s.log("Add listener for user",c),n.executeAsUser("addClickHandler",c.id,e.id))})}}static async handleTokenClick(e){var c;const t=e.currentTarget;if(!t)return!0;const n=t.document.getFlag(l,R);return n?(await U.toggleLightHidden(n),s.log(`Token clicked by ${(c=game.user)==null?void 0:c.name}`,{token:t.id,light:n,user:game.userId}),!1):!0}}r(S,"HOOK_NAME","leftClickToken"),r(S,"hookId");function F(d,e){return d.replace(/\${(\w+)}/g,(t,n)=>e[n]!==void 0?String(e[n]):"")}var y,z,I;const i=class i{};y=new WeakMap,z=new WeakMap,I=new WeakMap,G(i,y,"chekbox-input"),G(i,z,"text-input"),G(i,I,"${appId}.${flagPath}.${type}"),r(i,"trackLightPositionHook",(e,t)=>{if(s.log("========================================================="),s.log("---------------------------------------------------------"),s.log("AmbientLight updated!",document,t,"x"in t,"y"in t,"x"in t||"y"in t),"x"in t||"y"in t){s.log("Light position changed:",t.x,t.y);const n=e.getFlag(l,M),c=e.getFlag(l,T);if(s.log(`tokenId: ${c}`),!n||!c)return;f.changeTokenPositions(c,t.x,t.y)||(e.setFlag(l,T,""),e.setFlag(l,N,""))}}),r(i,"deleteAmbientLightHook",async(e,t,n)=>{s.log(`AMBIENT LIGHT ${e.id} WAS DELETED`);const c=e.getFlag(l,T);c&&await f.delete(c,null)}),r(i,"renderLightConfigHook",(e,t,n,c)=>{if(c&&!c.isFirstRender)return;const a=e.document,o=a.getFlag(l,M)??!1,u=i.createInteractiveCheckboxHtmlElement(e.id,o),p=a.getFlag(l,N),g=i.createInteractivePathHtmlElement(e.id,p,o),h=t.querySelector('[data-application-part="advanced"]');h==null||h.appendChild(u),h==null||h.appendChild(g),t.onsubmit=i.onConfigSubmit}),r(i,"createInteractiveCheckboxHtmlElement",(e,t)=>{const n=document.createElement("div");n.className="form-group";const c=document.createElement("label");c.innerText=game.i18n.localize(L);const a=document.createElement("div");a.className="form-fields";const o=document.createElement("input");o.type="checkbox",o.name=$,o.checked=t,o.id=F(m(i,I),{appId:e,flagPath:$,type:m(i,y)}),o.onchange=i.onInteractiveCheckboxChanged;const u=document.createElement("p");return u.className="hint",u.innerText=game.i18n.localize(_),a.appendChild(o),n.appendChild(c),n.appendChild(a),n.appendChild(u),n}),r(i,"createInteractivePathHtmlElement",(e,t,n)=>{const c=document.createElement("div");c.className="form-group",c.id=F(m(i,I),{appId:e,flagPath:H,type:"form-group"}),c.hidden=!n;const a=document.createElement("label");a.htmlFor=H,a.innerText=game.i18n.localize(ee);const o=document.createElement("div");return o.className="form-fields",o.innerHTML=`<file-picker name="${H}" type="image" id="${e}-${H}" value="${t??""}"></file-picker>`,c.appendChild(a),c.appendChild(o),c}),r(i,"onInteractiveCheckboxChanged",e=>{const t=e.target;if(!t)return;const n=t.id.slice(0,t.id.indexOf(F(m(i,I),{appId:"",flagPath:$,type:m(i,y)}))),c=t.checked,a=document.getElementById(F(m(i,I),{appId:n,flagPath:H,type:"form-group"}));a&&(a.hidden=!c)}),r(i,"onConfigSubmit",async e=>{var h;s.log("AMBIENT LIGHT CONFIGURATION SUBMITTED");const t=i.getInteractiveCheckbox(e.target),n=i.getPathInput(e.target),a=i.getAppIdFromInteractiveCheckbox(t).split("-").pop();if(!a)return;const o=(h=canvas.lighting)==null?void 0:h.get(a);if(!o)return;const u=o.document.getFlag(l,T),g=n.value||o.document.getFlag(l,N)||te;if(t.checked){if(await f.updateTextureSource(u,a,g))return;s.log("CREATING TOKEN"),f.createActorToken(g,f.culcObjPosition(o.position._x,"X"),f.culcObjPosition(o.position._y,"Y"),o.document).then(E=>{var A,D;if(s.log("DATA",E),!E)return;const j=(D=(A=game.canvas)==null?void 0:A.tokens)==null?void 0:D.get(E.id);s.log(j),j?S.addEventHandler(j):s.error("Couldn't find the new token and link the click handle event")})}else f.delete(u,o.document)}),r(i,"getInteractiveCheckbox",e=>e.querySelector(`[name="${$}"]`)),r(i,"getPathInput",e=>e.querySelector(`[name="${H}"]`)),r(i,"getAppIdFromInteractiveCheckbox",e=>e.id.slice(0,e.id.indexOf(F(m(i,I),{appId:"",flagPath:$,type:m(i,y)}))));let O=i;function oe(){Hooks.once("init",se),Hooks.once("ready",V)}function se(d){var e,t;Hooks.on("ready",V),Hooks.on("renderAmbientLightConfig",O.renderLightConfigHook),Hooks.on("updateAmbientLight",O.trackLightPositionHook),Hooks.on("deleteAmbientLight",O.deleteAmbientLightHook),(t=(e=game.modules)==null?void 0:e.get("socketlib"))!=null&&t.active||s.error("Socketlib is not active!"),U.init()}function V(){S.init()}oe();
