var V=Object.defineProperty;var M=d=>{throw TypeError(d)};var J=(d,e,t)=>e in d?V(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var r=(d,e,t)=>J(d,typeof e!="symbol"?e+"":e,t),Q=(d,e,t)=>e.has(d)||M("Cannot "+t);var m=(d,e,t)=>(Q(d,e,"read from private field"),t?t.call(d):e.get(d)),x=(d,e,t)=>e.has(d)?M("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(d):e.set(d,t);const Y="flags",l="interactive-light",j="interactive",O="path",y="token-id",F=`${Y}.${l}.${j}`,T=`${Y}.${l}.${O}`,R="light-id",z="INTERACTIVE_LIGHT",Z=`${z}.Enabled`,L=`${z}.EnabledHint`,_=`${z}.Path`,ee=CONST.DEFAULT_TOKEN;var q,A;const te=((A=(q=game.canvas)==null?void 0:q.grid)==null?void 0:A.size)??100;var B,X;const ce=((X=(B=game.canvas)==null?void 0:B.grid)==null?void 0:X.size)??100,P="color: #7bf542",G="color: #d8eb34",b="color: #ffffff";class s{static log(...e){this.minLogLevel>0||console.log("%c Interactive%cLight %c",P,G,b,...e)}static info(...e){this.minLogLevel>1||console.info("%c Interactive%cLight %c",P,G,b,...e)}static warn(...e){this.minLogLevel>2||console.warn("%c Interactive%cLight %c",P,G,b,...e)}static error(...e){this.minLogLevel>3||console.error("%c Interactive%cLight %c",P,G,b,...e)}}r(s,"minLogLevel",0);const v=class v{};r(v,"init",()=>{socketlib.registerModule(l),v.socketRegisterToggleLightHidden(),v.socketRegisterAddClickHandler()}),r(v,"socketRegisterToggleLightHidden",()=>{const e=socketlib.modules.get(l);e&&e.register("toggleLightHidden",t=>{var c,a;s.log("Chached the event");const n=(a=(c=game.canvas)==null?void 0:c.lighting)==null?void 0:a.get(t);return n?(s.log("Updating light document"),n.document.update({hidden:!n.document.hidden})):!1})}),r(v,"socketRegisterAddClickHandler",()=>{const e=socketlib.modules.get(l);e&&e.register("addClickHandler",(t,n)=>{var a,o;const c=(o=(a=game.canvas)==null?void 0:a.tokens)==null?void 0:o.get(t);s.log(c),c&&w.addEventHandler(c)})}),r(v,"toggleLightHidden",async e=>{var n,c,a;if(!e)return;const t=(c=(n=game.canvas)==null?void 0:n.lighting)==null?void 0:c.get(e);if(t){if(s.log("Found light",t),(a=game.user)!=null&&a.isGM){s.log("GM's click, allow to change the light"),await t.document.update({hidden:!t.document.hidden});return}if(s.log("User's click, sending the request to the server"),s.log("sending the request to the server"),s.log(socketlib),s.log(socketlib.modules),socketlib.modules.get(l)){const o=socketlib.modules.get(l);if(!o)return;o.executeAsGM("toggleLightHidden",e)}else s.error(`Couldn't find a registered module ${l}`);s.log(socketlib.modules)}});let U=v;class w{static init(){this.setupTokenClickHandler()}static setupTokenClickHandler(){var t,n,c;const e=((c=(n=(t=game.canvas)==null?void 0:t.tokens)==null?void 0:n.objects)==null?void 0:c.children).filter(a=>a.document.getFlag(l,R)).map(a=>(this.addEventHandler(a),a));s.log("Retriving tokens linked to a light object",e)}static addEventHandlerById(e){var n,c;const t=(c=(n=game.canvas)==null?void 0:n.tokens)==null?void 0:c.get(e);t&&this.addEventHandler(t)}static addEventHandler(e){e.onclick=this.handleTokenClick}static async handleTokenClick(e){var c;const t=e.currentTarget;if(!t)return!0;const n=t.document.getFlag(l,R);return n?(await U.toggleLightHidden(n),s.log(`Token clicked by ${(c=game.user)==null?void 0:c.name}`,{token:t.id,light:n,user:game.userId}),!1):!0}}r(w,"HOOK_NAME","leftClickToken"),r(w,"hookId");const p=class p{};r(p,"updateTextureSource",async(e,t,n)=>{var a,o,u;if(!((a=game.user)!=null&&a.isGM)||!e)return!1;const c=(u=(o=game.canvas)==null?void 0:o.tokens)==null?void 0:u.get(e);if(s.log(c),!c)return s.warn(`Token with ID ${e} not found`),!1;try{return s.log(`UPDATING TOKEN ${e} TEXTURE SOURCE`),await c.document.update({texture:{src:n}}),await c.document.setFlag(l,R,t),!0}catch(h){return s.error(`Failed to update token ${e}:`,h),!1}}),r(p,"delete",async(e,t)=>{var n,c,a,o,u,h,g;if((n=game.user)!=null&&n.isGM){if(e){const k=(a=(c=game.canvas)==null?void 0:c.tokens)==null?void 0:a.get(e);if(k){s.log(`DELETING TOKEN: ${e}`);const E=(o=k.actor)==null?void 0:o.id;if((h=(u=game.canvas)==null?void 0:u.tokens)==null||h.removeChild(k),await k.document.delete(),E){const H=(g=game.actors)==null?void 0:g.get(E);H&&(s.log(`DELETING ASSOCIATED ACTOR: ${E}`),await H.delete())}}}t&&(t.setFlag(l,y,e),t.setFlag(l,O,""))}}),r(p,"createActor",async e=>{var n;return(n=game.user)!=null&&n.isGM?await Actor.create({name:`light-${e}`,type:"base"}):void 0}),r(p,"createActorToken",async(e,t,n,c)=>{var h,g,k,E,H;if(!(c!=null&&c.id))return;const a=await p.createActor(c.id);if(!a)return;s.log("light pos",`${t} : ${n}`);const o=await TokenDocument.create({name:a.name,actorId:a.id,x:t,y:n,width:1,height:1,disposition:CONST.TOKEN_DISPOSITIONS.SECRET,texture:{src:e,anchorX:.5,anchorY:.5}},{parent:canvas.scene});if(s.log("Token doc created",o),!o)return;o==null||o.update({movementAction:"blink"});const u=(g=(h=game.canvas)==null?void 0:h.tokens)==null?void 0:g.get(o.id);if(u){u.onclick=w.handleTokenClick,s.log("Tocken created",(E=(k=game.canvas)==null?void 0:k.tokens)==null?void 0:E.get(o.id));const C=socketlib.modules.get(l);C&&((H=game.users)==null||H.forEach(K=>{K.isGM||C.executeAsUser("addClickHandler",K.id,u.id)}))}return await o.setFlag(l,R,c.id),await c.setFlag(l,y,o.id),o}),r(p,"changeTokenPositions",async(e,t,n)=>{var o,u,h;if(!((o=game.user)!=null&&o.isGM))return!1;const c=(h=(u=game.canvas)==null?void 0:u.tokens)==null?void 0:h.get(e);if(!c)return s.log(`Couldn't find a token with id ${e}`),!1;const a={};if(t===0||t){const g=p.culcObjPosition(t,"X");a.x=g,s.log(`POS X UPDATED: ${g}`)}if(n===0||n){const g=p.culcObjPosition(n,"Y");a.y=g,s.log(`POS Y UPDATED: ${g}`)}if(Object.keys(a).length>0)try{await c.document.update(a)}catch(g){s.error(`Unnable to update token [${e}]`),console.log(g)}return!0}),r(p,"culcObjPosition",(e,t)=>e-p.getTileSize(t)/2),r(p,"getTileSize",e=>{switch(e){case"X":return ce;case"Y":return te}});let f=p;function N(d,e){return d.replace(/\${(\w+)}/g,(t,n)=>e[n]!==void 0?String(e[n]):"")}var $,D,I;const i=class i{};$=new WeakMap,D=new WeakMap,I=new WeakMap,x(i,$,"chekbox-input"),x(i,D,"text-input"),x(i,I,"${appId}.${flagPath}.${type}"),r(i,"trackLightPositionHook",(e,t)=>{if(s.log("========================================================="),s.log("---------------------------------------------------------"),s.log("AmbientLight updated!",document,t,"x"in t,"y"in t,"x"in t||"y"in t),"x"in t||"y"in t){s.log("Light position changed:",t.x,t.y);const n=e.getFlag(l,j),c=e.getFlag(l,y);if(s.log(`tokenId: ${c}`),!n||!c)return;f.changeTokenPositions(c,t.x,t.y)||(e.setFlag(l,y,""),e.setFlag(l,O,""))}}),r(i,"deleteAmbientLightHook",async(e,t,n)=>{s.log(`AMBIENT LIGHT ${e.id} WAS DELETED`);const c=e.getFlag(l,y);c&&await f.delete(c,null)}),r(i,"renderLightConfigHook",(e,t,n,c)=>{if(c&&!c.isFirstRender)return;const a=e.document,o=a.getFlag(l,j)??!1,u=i.createInteractiveCheckboxHtmlElement(e.id,o),h=a.getFlag(l,O),g=i.createInteractivePathHtmlElement(e.id,h,o),k=t.querySelector('[data-application-part="advanced"]');k==null||k.appendChild(u),k==null||k.appendChild(g),t.onsubmit=i.onConfigSubmit}),r(i,"createInteractiveCheckboxHtmlElement",(e,t)=>{const n=document.createElement("div");n.className="form-group";const c=document.createElement("label");c.innerText=game.i18n.localize(Z);const a=document.createElement("div");a.className="form-fields";const o=document.createElement("input");o.type="checkbox",o.name=F,o.checked=t,o.id=N(m(i,I),{appId:e,flagPath:F,type:m(i,$)}),o.onchange=i.onInteractiveCheckboxChanged;const u=document.createElement("p");return u.className="hint",u.innerText=game.i18n.localize(L),a.appendChild(o),n.appendChild(c),n.appendChild(a),n.appendChild(u),n}),r(i,"createInteractivePathHtmlElement",(e,t,n)=>{const c=document.createElement("div");c.className="form-group",c.id=N(m(i,I),{appId:e,flagPath:T,type:"form-group"}),c.hidden=!n;const a=document.createElement("label");a.htmlFor=T,a.innerText=game.i18n.localize(_);const o=document.createElement("div");return o.className="form-fields",o.innerHTML=`<file-picker name="${T}" type="image" id="${e}-${T}" value="${t??""}"></file-picker>`,c.appendChild(a),c.appendChild(o),c}),r(i,"onInteractiveCheckboxChanged",e=>{const t=e.target;if(!t)return;const n=t.id.slice(0,t.id.indexOf(N(m(i,I),{appId:"",flagPath:F,type:m(i,$)}))),c=t.checked,a=document.getElementById(N(m(i,I),{appId:n,flagPath:T,type:"form-group"}));a&&(a.hidden=!c)}),r(i,"onConfigSubmit",async e=>{var k;s.log("AMBIENT LIGHT CONFIGURATION SUBMITTED");const t=i.getInteractiveCheckbox(e.target),n=i.getPathInput(e.target),a=i.getAppIdFromInteractiveCheckbox(t).split("-").pop();if(!a)return;const o=(k=canvas.lighting)==null?void 0:k.get(a);if(!o)return;const u=o.document.getFlag(l,y),g=n.value||o.document.getFlag(l,O)||ee;if(t.checked){if(await f.updateTextureSource(u,a,g))return;s.log("CREATING TOKEN"),f.createActorToken(g,f.culcObjPosition(o.position._x,"X"),f.culcObjPosition(o.position._y,"Y"),o.document).then(H=>{s.log("DATA",H)})}else f.delete(u,o.document)}),r(i,"getInteractiveCheckbox",e=>e.querySelector(`[name="${F}"]`)),r(i,"getPathInput",e=>e.querySelector(`[name="${T}"]`)),r(i,"getAppIdFromInteractiveCheckbox",e=>e.id.slice(0,e.id.indexOf(N(m(i,I),{appId:"",flagPath:F,type:m(i,$)}))));let S=i;function ne(){Hooks.once("init",ae),Hooks.once("ready",W)}function ae(d){var e,t;Hooks.on("ready",W),Hooks.on("renderAmbientLightConfig",S.renderLightConfigHook),Hooks.on("updateAmbientLight",S.trackLightPositionHook),Hooks.on("deleteAmbientLight",S.deleteAmbientLightHook),(t=(e=game.modules)==null?void 0:e.get("socketlib"))!=null&&t.active||s.error("Socketlib is not active!"),U.init()}function W(){w.init()}ne();
